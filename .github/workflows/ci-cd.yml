name: CI with kind (build once, then notify GitOps)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  AUTH_IMAGE_NAME: ${{ github.repository_owner }}/auth-server
  CLIENT_IMAGE_NAME: ${{ github.repository_owner }}/client-app
  SPACETIME_IMAGE_NAME: ${{ github.repository_owner }}/spacetime-db
  IMAGE_TAG: ${{ github.sha }} # single artifact tag used across all services

jobs:
  build-and-test-kind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: isirajieinnocent              # your GitHub username
          password: ${{ secrets.GHCR_PAT }}       # PAT with write:packages

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Debug workspace
        run: |
          echo "Commit: $GITHUB_SHA"
          pwd
          ls -la
          echo "Searching for Dockerfiles..."
          find . -maxdepth 4 -type f -name 'Dockerfile*' || true
          echo "Tracked files (first 200):"
          git ls-files | sed -n '1,200p'

      # 1) Build Auth Server
      - name: Build and push Auth Server
        uses: docker/build-push-action@v4
        with:
          context: ./auth-server-openauth
          file: ./auth-server-openauth/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.AUTH_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.AUTH_IMAGE_NAME }}:latest
          platforms: linux/amd64
          build-args: |
            VERSION=${{ env.IMAGE_TAG }}

      # 2) Build Client App
      - name: Build and push Client App
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.client
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.CLIENT_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.CLIENT_IMAGE_NAME }}:latest
          platforms: linux/amd64
          build-args: |
            VERSION=${{ env.IMAGE_TAG }}

      # 3) Build SpacetimeDB
      - name: Build and push SpacetimeDB
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.spacetime
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.SPACETIME_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.SPACETIME_IMAGE_NAME }}:latest
          platforms: linux/amd64

      - name: Verify pushed images
        run: |
          echo "Verifying Auth Server: $REGISTRY/$AUTH_IMAGE_NAME:$IMAGE_TAG"
          docker pull $REGISTRY/$AUTH_IMAGE_NAME:$IMAGE_TAG || exit 1
          
          echo "Verifying Client: $REGISTRY/$CLIENT_IMAGE_NAME:$IMAGE_TAG"
          docker pull $REGISTRY/$CLIENT_IMAGE_NAME:$IMAGE_TAG || exit 1
          
          echo "Verifying SpacetimeDB: $REGISTRY/$SPACETIME_IMAGE_NAME:$IMAGE_TAG"
          docker pull $REGISTRY/$SPACETIME_IMAGE_NAME:$IMAGE_TAG || exit 1

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: ci-cluster

      - name: Show cluster info
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespaces
        run: |
          kubectl get ns dev || kubectl create ns dev
          kubectl get ns staging || kubectl create ns staging

      - name: Load all images into kind cluster
        run: |
          kind load docker-image $REGISTRY/$AUTH_IMAGE_NAME:$IMAGE_TAG --name ci-cluster
          kind load docker-image $REGISTRY/$CLIENT_IMAGE_NAME:$IMAGE_TAG --name ci-cluster
          kind load docker-image $REGISTRY/$SPACETIME_IMAGE_NAME:$IMAGE_TAG --name ci-cluster

      # Deploy Auth Server to DEV
      - name: Deploy Auth Server to DEV
        run: |
          echo "Deploying Auth Server to DEV with image: $REGISTRY/$AUTH_IMAGE_NAME:$IMAGE_TAG"
          helm upgrade --install auth-server-dev ./helm/auth-server \
            --namespace dev --create-namespace \
            --set image.repository=$REGISTRY/$AUTH_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-auth-dev.yaml
          kubectl -n dev rollout status deployment/auth-server

      # Deploy Client App to DEV
      - name: Deploy Client App to DEV
        run: |
          echo "Deploying Client App to DEV with image: $REGISTRY/$CLIENT_IMAGE_NAME:$IMAGE_TAG"
          helm upgrade --install client-app-dev ./helm/client-app \
            --namespace dev --create-namespace \
            --set image.repository=$REGISTRY/$CLIENT_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-client-dev.yaml
          kubectl -n dev rollout status deployment/client-app

      # Deploy SpacetimeDB to DEV
      - name: Deploy SpacetimeDB to DEV
        run: |
          echo "Deploying SpacetimeDB to DEV with image: $REGISTRY/$SPACETIME_IMAGE_NAME:$IMAGE_TAG"
          helm upgrade --install spacetime-db-dev ./helm/spacetime-db \
            --namespace dev --create-namespace \
            --set image.repository=$REGISTRY/$SPACETIME_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-spacetime-dev.yaml
          kubectl -n dev rollout status deployment/spacetime-db

      # Deploy all services to STAGING
      - name: Deploy to STAGING (all services)
        run: |
          echo "Deploying all services to STAGING with tag: $IMAGE_TAG"

          # Auth Server
          helm upgrade --install auth-server-staging ./helm/auth-server \
            --namespace staging --create-namespace \
            --set image.repository=$REGISTRY/$AUTH_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-auth-staging.yaml
          
          # Client App
          helm upgrade --install client-app-staging ./helm/client-app \
            --namespace staging --create-namespace \
            --set image.repository=$REGISTRY/$CLIENT_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-client-staging.yaml
          
          # SpacetimeDB
          helm upgrade --install spacetime-db-staging ./helm/spacetime-db \
            --namespace staging --create-namespace \
            --set image.repository=$REGISTRY/$SPACETIME_IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            -f ./helm/values-spacetime-staging.yaml
          
          # Wait for all deployments
          kubectl -n staging rollout status deployment/auth-server
          kubectl -n staging rollout status deployment/client-app
          kubectl -n staging rollout status deployment/spacetime-db

      - name: Smoke test STAGING
        run: |
          echo "Testing all services in STAGING..."
          echo "1. Testing Auth Server..."
          kubectl -n staging get pods -l app=auth-server
          echo "2. Testing Client App..."
          kubectl -n staging get pods -l app=client-app
          echo "3. Testing SpacetimeDB..."
          kubectl -n staging get pods -l app=spacetime-db
          echo "Smoke test placeholder passed"

      # Notify GitOps repo that images are ready for promotion
      - name: Notify GitOps repo (repository_dispatch)
        env:
          GITOPS_PAT: ${{ secrets.GITOPS_PAT }}     # PAT with access to GitOps repo
          GITOPS_REPO: ${{ github.repository_owner }}/my-app-gitops
        run: |
          echo "Triggering GitOps promotion workflow for all services"

          AUTH_IMAGE_TAG="${REGISTRY}/${AUTH_IMAGE_NAME}:${IMAGE_TAG}"
          CLIENT_IMAGE_TAG="${REGISTRY}/${CLIENT_IMAGE_NAME}:${IMAGE_TAG}"
          SPACETIME_IMAGE_TAG="${REGISTRY}/${SPACETIME_IMAGE_NAME}:${IMAGE_TAG}"

          echo "Auth image: ${AUTH_IMAGE_TAG}"
          echo "Client image: ${CLIENT_IMAGE_TAG}"
          echo "Spacetime image: ${SPACETIME_IMAGE_TAG}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITOPS_PAT}" \
            https://api.github.com/repos/${GITOPS_REPO}/dispatches \
            -d "{
              \"event_type\": \"promote-prod\",
              \"client_payload\": {
                \"auth_image\": \"${AUTH_IMAGE_TAG}\",
                \"client_image\": \"${CLIENT_IMAGE_TAG}\",
                \"spacetime_image\": \"${SPACETIME_IMAGE_TAG}\",
                \"image_tag\": \"${IMAGE_TAG}\"
              }
            }"
